{% extends "admin_dashboard.html" %}
{% block content %}
<link rel="stylesheet" href="../static/assets/css/styles.min.css" />
<link rel="stylesheet" href="../static/assets/css/n.css" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

<style>
.attendance-container { max-width: 900px; margin: 0 auto; padding: 20px; }
.attendance-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
.attendance-header h2 { margin: 0; font-size: 24px; }
.scanner-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; font-weight: 600; margin-bottom: 5px; color: #333; }
.form-control { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
.form-control:focus { border-color: #667eea; outline: none; }
.video-container { width: 100%; max-width: 400px; margin: 15px auto; border: 2px solid #667eea; border-radius: 8px; overflow: hidden; background: #000; }
#scanner { width: 100%; height: 300px; display: block; }
.camera-feed { width: 100%; height: 300px; object-fit: cover; }
.btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 14px; }
.btn-primary { background: #667eea; color: white; }
.btn-primary:hover { background: #5568d3; }
.btn-secondary { background: #f0f0f0; color: #333; }
.btn-secondary:hover { background: #e0e0e0; }
.btn-group { display: flex; gap: 10px; margin-top: 15px; }
.btn-group .btn { flex: 1; }
.marked-students { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.marked-students h3 { margin-top: 0; color: #333; }
.student-entry { background: #f9f9f9; padding: 12px; border-left: 4px solid #667eea; margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
.student-entry .name { font-weight: 600; color: #333; }
.student-entry .time { font-size: 12px; color: #666; }
.status-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
.status-present { background: #d4edda; color: #155724; }
.alert { padding: 12px; border-radius: 5px; margin-bottom: 15px; }
.alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.scanner-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
.scanner-toggle button { flex: 1; padding: 10px; border: 2px solid #ddd; background: white; color: #333; font-weight: 600; cursor: pointer; border-radius: 5px; }
.scanner-toggle button.active { border-color: #667eea; background: #667eea; color: white; }
.scanning-status { text-align: center; padding: 10px; font-size: 13px; color: #666; }
.scanning-status.active { color: #667eea; font-weight: 600; }
@media (max-width: 600px) { .btn-group { flex-direction: column; } .attendance-header h2 { font-size: 18px; } }
</style>

<div class="attendance-container">
  <div class="attendance-header">
    <h2><i class="fas fa-clipboard-list"></i> Student Attendance</h2>
    <p style="margin: 10px 0 0 0; font-size: 14px;">Date: <span id="dateDisplay">{{ current_date }}</span></p>
  </div>

  <div class="scanner-section">
    <div class="scanner-toggle">
      <button class="active" onclick="toggleMode('scanner')"><i class="fas fa-qrcode"></i> QR Scanner</button>
      <button onclick="toggleMode('manual')"><i class="fas fa-keyboard"></i> Manual Entry</button>
    </div>

    <div id="scannerMode">
      <label>Python QR Code Scanner (Camera-based)</label>
      <div class="video-container">
        <img id="scanner" class="camera-feed" alt="Camera feed from server" />
      </div>
      <div class="scanning-status" id="scanningStatus">Ready to scan...</div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="startPythonScanner()"><i class="fas fa-play"></i> Start Scanner</button>
        <button class="btn btn-secondary" onclick="stopPythonScanner()"><i class="fas fa-stop"></i> Stop</button>
      </div>
    </div>

    <div id="manualMode" style="display: none;">
      <div class="form-group">
        <label for="admissionInput">Admission Number</label>
        <input type="text" id="admissionInput" class="form-control" placeholder="Enter admission number" onkeypress="handleManualEntry(event)">
      </div>
      <button class="btn btn-primary" onclick="submitManualEntry()"><i class="fas fa-check"></i> Mark Present</button>
    </div>

    <div id="messageArea"></div>
  </div>

  <div class="marked-students">
    <h3><i class="fas fa-check-circle"></i> Marked Present Today (<span id="countMarked">0</span>)</h3>
    <div id="markedList"></div>
  </div>
</div>

<script>
let scannerActive = false;
let scannerInterval = null;

function toggleMode(mode) {
  document.getElementById('scannerMode').style.display = mode === 'scanner' ? 'block' : 'none';
  document.getElementById('manualMode').style.display = mode === 'manual' ? 'block' : 'none';
  document.querySelectorAll('.scanner-toggle button').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  if (mode === 'scanner') startPythonScanner();
  else stopPythonScanner();
}

function startPythonScanner() {
  if (scannerActive) return;
  
  scannerActive = true;
  updateScanningStatus('Starting Python QR scanner...', true);
  
  // Scan every 500ms
  scannerInterval = setInterval(() => {
    performPythonQRScan();
  }, 500);
}

function stopPythonScanner() {
  scannerActive = false;
  if (scannerInterval) {
    clearInterval(scannerInterval);
    scannerInterval = null;
  }
  updateScanningStatus('Scanner stopped', false);
}

function performPythonQRScan() {
  if (!scannerActive) return;
  
  fetch('/scan_qr_python', {
    method: 'GET',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(response => response.json())
  .then(data => {
    // Display camera frame
    if (data.frame) {
      const img = document.getElementById('scanner');
      img.src = 'data:image/jpeg;base64,' + data.frame;
    }
    
    // If QR code detected
    if (data.success && data.qr_detected && data.admission_no) {
      updateScanningStatus('QR code detected! Processing...', true);
      markAttendance(data.admission_no);
      stopPythonScanner();
    } else if (data.qr_detected && !data.admission_no) {
      updateScanningStatus('QR detected but invalid format', false);
    } else {
      updateScanningStatus('Scanning for QR codes...', true);
    }
  })
  .catch(err => {
    updateScanningStatus('Scanning error: ' + err.message, false);
    console.error('Scan error:', err);
  });
}

function updateScanningStatus(message, isActive) {
  const status = document.getElementById('scanningStatus');
  status.textContent = message;
  status.classList.toggle('active', isActive);
}

function handleManualEntry(event) {
  if (event.key === 'Enter') {
    submitManualEntry();
  }
}

function submitManualEntry() {
  const admission = document.getElementById('admissionInput').value.trim();
  if (admission) {
    markAttendance(admission);
    document.getElementById('admissionInput').value = '';
    document.getElementById('admissionInput').focus();
  }
}

function markAttendance(admissionNo) {
  // Check in database if already marked
  const date = document.getElementById('dateDisplay').textContent;
  
  fetch('/mark_attendance', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      admission_no: admissionNo,
      date: date
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showMessage(data.message, 'success');
      
      // Refresh list from database
      loadAndDisplayMarkedStudents();
      
      // Restart scanner after a delay
      if (scannerActive === false) {
        setTimeout(() => startPythonScanner(), 2000);
      }
    } else {
      showMessage(data.message, 'error');
    }
  })
  .catch(err => {
    showMessage('Error: ' + err.message, 'error');
    console.error('Fetch error:', err);
  });
}

function loadAndDisplayMarkedStudents() {
  const date = document.getElementById('dateDisplay').textContent;
  
  fetch(`/get_todays_marked_students?date=${date}`)
    .then(response => response.json())
    .then(data => {
      if (data.success && data.students) {
        displayMarkedStudents(data.students);
      } else {
        displayMarkedStudents([]);
      }
    })
    .catch(err => {
      console.error('Error loading marked students:', err);
      displayMarkedStudents([]);
    });
}

function displayMarkedStudents(students) {
  document.getElementById('countMarked').textContent = students.length;
  const list = document.getElementById('markedList');
  
  if (students.length === 0) {
    list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No students marked yet</div>';
    return;
  }
  
  list.innerHTML = students.map(student => `
    <div class="student-entry">
      <div>
        <div class="name">${student.name}</div>
        <div class="time" style="font-size: 13px; color: #555; margin-top: 2px;">
          <i class="fas fa-graduation-cap"></i> ${student.grade || 'N/A'} | ${student.admission}
        </div>
      </div>
      <div>
        <span class="status-badge status-present">âœ“ ${student.time}</span>
      </div>
    </div>
  `).join('');
}

function showMessage(message, type) {
  const area = document.getElementById('messageArea');
  area.innerHTML = `<div class="alert alert-${type}"><i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}</div>`;
  setTimeout(() => { area.innerHTML = ''; }, 4000);
}

// Load marked students when page loads
window.addEventListener('load', () => {
  document.getElementById('admissionInput').focus();
  loadAndDisplayMarkedStudents();
  setTimeout(() => startPythonScanner(), 500);
});

// Stop scanner when page unloads
window.addEventListener('beforeunload', () => {
  stopPythonScanner();
});
</script>

{% endblock %}
